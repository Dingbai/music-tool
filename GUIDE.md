这份产品文档总结了您所开发的 **“AI 音乐助教工作站 (AI Music Workstation)”**。该产品集成了 ABC 记谱法编辑、多音色 MIDI 播放以及基于 Web Audio API 的实时录音练习与反馈系统。

---

# 产品需求文档 (PRD) - AI 音乐助教工作站

## 1. 产品概述

一款面向音乐学习者和创作者的 Web 端集成工具。用户可以通过 ABC 记谱法快速创作乐谱，切换多种 MIDI 音色进行试听，并利用 AI 音高识别技术进行实弹练习，获取实时的纠错反馈。

## 2. 核心模块说明

### 2.1 编辑模式 (Editor Mode)

- **功能描述**：提供乐谱的源码级编辑与实时预览。
- **核心特性**：
- **实时渲染**：基于 ABC 记谱法语法，输入代码即时生成标准的五线谱 SVG。
- **点击发音**：点击乐谱上的任意音符，系统通过合成器触发对应音高的 MIDI 声音。
- **响应式布局**：乐谱根据屏幕宽度自动缩放，保证移动端与桌面端的兼容性。

### 2.2 播放模式 (Playback Mode)

- **功能描述**：高质量的乐谱回放与音色调试。
- **核心特性**：
- **多音色切换**：支持包括钢琴、小号、手风琴、哈泼琴在内的多种通用 MIDI (GM) 音色。
- **光标同步跟随**：回放时，红色光标随节奏在五线谱上精确移动，并高亮当前播放的音符。
- **播放控制**：集成完整的控制器（播放、暂停、进度条、循环、调速）。
- **MIDI 导出**：支持将当前编辑的乐谱一键导出为标准 MIDI 文件。

### 2.3 练习模式 (Practice Mode)

- **功能描述**：通过麦克风录音，实现“演奏 - 识别 - 纠错”的闭环练习。
- **核心特性**：
- **实时音高检测 (Pitch Detection)**：采用 **YIN 算法** 实时分析麦克风输入的频率，并将其转化为 MIDI 编号。
- **节拍器 (Metronome)**：提供基于 Web Audio 硬件时钟的高精度节拍点，辅助用户保持稳定节奏。
- **静音陪伴 (Ghost Mode)**：用户可在耳机中收听标准伴奏，系统只录制纯净的乐器声音，提升 AI 识别准度。
- **视觉纠错**：
- **成功标记**：演奏音高正确时，乐谱音符实时变为**绿色**。
- **错误标记**：音高偏差或节奏错误时，音符变更为**红色**。

- **AI 练习报告**：练习结束后自动生成综合评分报告，记录准确率、总音符数，并给出具体的改进建议。

---

## 3. 技术架构 (Technical Stack)

| 维度          | 技术选型          | 说明                                                     |
| ------------- | ----------------- | -------------------------------------------------------- |
| **框架层**    | React (Hooks)     | 负责状态管理与组件生命周期同步                           |
| **渲染层**    | ABCJS             | 处理乐谱渲染及底层 MIDI 合成                             |
| **音频引擎**  | Web Audio API     | 提供 AudioContext 及其各种音频节点 (Analyser, Gain, Osc) |
| **识别算法**  | YIN Algorithm     | 用于单声部乐器的自相关频率检测，具有极高的稳定性         |
| **UI 组件库** | Ant Design (antd) | 提供编辑框、选择器、进度条、Modal 及加载动画             |

---

## 4. 用户交互流程 (User Journey)

1. **准备阶段**：在**编辑模式**输入乐谱 -> 切换至**播放模式**点击“激活音频”。
2. **试听阶段**：选择心仪音色（如：小号），点击播放，观察光标跟随情况。
3. **练习阶段**：进入**练习模式**，设置 BPM（每分钟节拍数），开启节拍器和静音伴奏。
4. **实时练习**：点击“开始练习”，对着麦克风演奏。系统根据吹奏频率动态改变乐谱颜色。
5. **总结改进**：点击“结束练习”，查看 AI 生成的练习报告，根据评分和建议进行针对性提升。

---

## 5. 设计约束与安全

- **浏览器政策**：必须由用户主动点击（User Gesture）才能启动 AudioContext，解决 Chrome 自动播放限制导致的静音问题。
- **环境噪声**：练习模式建议在相对安静的环境下或佩戴耳机（使用 Ghost Mode）使用，以获得最佳识别效果。
- **延迟补偿**：针对浏览器录音的物理延迟，系统在对比时间轴时预留了 50ms-100ms 的逻辑补偿窗口。

---

## 6. 后续迭代计划 (Roadmap)

- **V2.0**：支持多声部乐谱识别。
- **V2.1**：引入“指法教学”弹窗，针对特定音符显示笛子/黑管指法图。
- **V2.2**：支持云端保存练习历史，生成长期进步曲线图表。
